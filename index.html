<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‑8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard Monitoring KSO</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div style="text-align:center;font-size:2em;margin:20px;">Dashboard Monitoring KSO</div>
  <div>
    <select id="projectList" onchange="handleProjectChange()"></select>
    <select id="unitList" onchange="filterData()"></select>
    <select id="dataLimit" onchange="filterData()">
      <option>10</option><option>50</option><option>100</option><option>500</option>
    </select>
  </div>
  <div id="summary" style="display:flex;gap:1rem;margin:20px;"></div>
  <table id="dataTable" border="1" width="100%" style="margin-top:20px;"></table>

<script>
const fallbackData = [
  /* contoh fallback minimal:
  {NIP:'001',NAMA:'ANDI',UNIT:'BANJARBARU',JABATAN:'ADMIN',SPK:'SPK-001','LOKASI ABSEN':'OFFICE',KETERANGAN:'BELUM ABSENSI',PROJECT:'PROJ A',CABANG:'CABANG KALSEL'}
  */
];
let rawData = [];

function init(data){
  rawData = data;
  populateProjectDropdown();
  filterData();
}

Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vQ99AnzKxfM4RiLan520o2whUadT-vxlbgBCXbSPy9AeW110OHI3SezC1AVxHXwnG681jWB6LVv9p2c/pub?gid=902005521&single=true&output=csv',{
  download:true, header:true,
  complete(res){ if(res.data.length) init(res.data); else init(fallbackData); },
  error(){ init(fallbackData); }
});

function populateProjectDropdown(){
  const projects = [...new Set(rawData.map(r=>r.PROJECT).filter(x=>x))].sort();
  document.getElementById('projectList').innerHTML = '<option>ALL PROJECT</option>'+projects.map(p=>`<option>${p}</option>`).join('');
  populateUnitDropdown('ALL PROJECT');
}
function populateUnitDropdown(proj){
  let units = rawData.filter(r=>proj==='ALL PROJECT'||r.PROJECT===proj).map(r=>r.UNIT).filter(x=>x);
  units = [...new Set(units)].sort();
  document.getElementById('unitList').innerHTML = '<option>ALL UNIT</option>'+units.map(u=>`<option>${u}</option>`).join('');
}
function handleProjectChange(){
  populateUnitDropdown(document.getElementById('projectList').value);
  filterData();
}
function filterData(){
  const proj = document.getElementById('projectList').value;
  const unit = document.getElementById('unitList').value;
  const limit = +document.getElementById('dataLimit').value;
  let filtered = rawData.filter(r=>(proj==='ALL PROJECT'||r.PROJECT===proj)&&(unit==='ALL UNIT'||r.UNIT===unit));
  filtered.sort((a,b)=>(a.JABATAN||'').localeCompare(b.JABATAN||'')||(a.NAMA||'').localeCompare(b.NAMA||''));
  renderTable(filtered.slice(0,limit));
  renderSummary(filtered);
}
function renderTable(data){
  const headers = ['NIP','NAMA','UNIT','JABATAN','SPK','LOKASI ABSEN','KETERANGAN'];
  const tbl = document.getElementById('dataTable');
  tbl.innerHTML = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  data.forEach(r=>{
    tbl.innerHTML += '<tr>'+headers.map(h=>`<td>${r[h]||''}</td>`).join('')+'</tr>';
  });
}
function renderSummary(data){
  ['CABANG KALSEL','CABANG KALTENG'].forEach(c=>{
    updateSummary(data.filter(r=>r.CABANG&&r.CABANG.trim()===c),c.toLowerCase().includes('kalteng')?'kalteng':'kalsel');
  });
  // gabungan
  updateSummary(data.filter(r=>['CABANG KALSEL','CABANG KALTENG'].includes((r.CABANG||'').trim())),'total');
}
function updateSummary(data, prefix){
  const total=data.length, belum=data.filter(r=>r.KETERANGAN==='BELUM ABSENSI').length, sudah=total-belum;
  const bp=total?Math.round(belum/total*100):0, sp=total?Math.round(sudah/total*100):0;
  const div=document.getElementById('summary');
  const card=document.getElementById(prefix+'Card') || (()=>{
    const d=document.createElement('div'); d.id=prefix+'Card';
    d.style.border="1px solid #ccc"; d.style.padding="10px"; d.style.width="180px";
    div.appendChild(d); return d;
  })();
  card.innerHTML = `<strong>${prefix==='total'?'KALSEL‑TENG':prefix.replace(/^./,m=>m.toUpperCase())}</strong><br>
    BELUM: ${belum} | ${bp}%<br>
    SUDAH: ${sudah} | ${sp}%<br>
    TOTAL: ${total}`;
}
</script>
</body>
</html>
